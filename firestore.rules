rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function hasActiveSubscription() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData.subscriptionStatus == 'active' ||
             (userData.subscriptionStatus == 'trial' &&
              userData.trialSessionsUsed < userData.trialSessionsTotal);
    }

    // Users collection
    match /users/{userId} {
      // Users can read and write their own profile
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
                       // Prevent users from modifying subscription status directly
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscriptionStatus', 'trialSessionsTotal']);
      allow delete: if isOwner(userId);
    }

    // Sessions collection
    match /sessions/{sessionId} {
      // Users can only read/write their own sessions
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasActiveSubscription();
      allow update: if isSignedIn() &&
                       resource.data.userId == request.auth.uid &&
                       // Only allow updating certain fields
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['code', 'codeHistory', 'chatHistory', 'testResults', 'status', 'endTime', 'duration', 'aiScore', 'aiFeedback']);
      allow delete: if isOwner(resource.data.userId);
    }

    // Problems collection
    match /problems/{problemId} {
      // Authenticated users can read problems
      allow read: if isSignedIn();
      // Only admins can create/update/delete problems
      // TODO: Implement admin role check
      allow write: if false; // Disabled for now, use Cloud Functions
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // Users can read their own subscription
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Only Cloud Functions can write subscriptions (via Stripe webhooks)
      allow write: if false;
    }

    // Rate limits collection (internal use only)
    match /rateLimits/{userId} {
      // Only Cloud Functions can access
      allow read, write: if false;
    }
  }
}
